ckage org.sharedhealth.datasense.export.dhis;

import freemarker.template.Configuration;
import freemarker.template.Template;
import freemarker.template.TemplateException;
import freemarker.template.TemplateExceptionHandler;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.sharedhealth.datasense.helpers.DatabaseHelper;
import org.sharedhealth.datasense.helpers.TestConfig;
import org.sharedhealth.datasense.launch.DatabaseConfig;
import org.sharedhealth.datasense.model.Patient;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestPropertySource;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import javax.sql.DataSource;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.io.Writer;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.SimpleDateFormat;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.junit.Assert.assertEquals;

@RunWith(SpringJUnit4ClassRunner.class)
@TestPropertySource("/test-shr-datasense.properties")
@ContextConfiguration(classes = {DatabaseConfig.class, TestConfig.class})
public class DHISDatasetExportIntegrationTest {

    private Configuration cfg;
    @Autowired
    JdbcTemplate jdbcTemplate;

    @Autowired
    private DataSource dataSource;

    @Before
    public void setup() throws IOException {
        cfg = new Configuration(Configuration.VERSION_2_3_21);
        cfg.setClassForTemplateLoading(this.getClass(), "/dhis/templates/");
        cfg.setDefaultEncoding("UTF-8");
        cfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
    }


    @Test
    public void shouldGenerateContentForDHIS() throws IOException, TemplateException {
        Template temp = cfg.getTemplate("DTFTest.ftl");
        Map model = new HashMap();
        model.put("dataset", "KvrdDT4bwn9");
        model.put("period", "201410");
        Writer out = new OutputStreamWriter(System.out);
        temp.process(model, out);
    }

    @Test
    public void shouldInsertDataFromCSV() throws IOException, TemplateException {
        jdbcTemplate.execute("INSERT INTO patient SELECT * FROM CSVREAD('classpath:/csv/patients.csv') ");

        List<Patient> patients = jdbcTemplate.query("select patient_hid,dob,gender,present_location_id from patient where patient_hid=123", new RowMapper<Patient>() {
            @Override
            public Patient mapRow(ResultSet rs, int rowNum) throws SQLException {
                Patient patient = new Patient();
                patient.setDateOfBirth(rs.getDate("dob"));
                patient.setGender(rs.getString("gender"));
                patient.setHid(rs.getString("patient_hid"));
                patient.setPresentAddressCode(rs.getString("present_location_id"));
                return patient;
            }
        });

        Patient patient = patients.get(0);
        assertEquals("123", patient.getHid());
        assertEquals("M", patient.getGender());
        assertEquals("1000", patient.getPresentLocationCode());
        SimpleDateFormat actual = new SimpleDateFormat("YYYY-MM-dd");

        assertEquals("2013-10-10", actual.format(patient.getDateOfBirth()));
    }

    @Test
    public void testingDataset() throws SQLException {
        System.out.println("*****************************************");
        System.out.println(dataSource.getConnection());
        System.out.println("*****************************************");
    }

    @Test
    public void shouldPostValues() {
//        jdbcTemplate.execute("Insert into facility select * from CSVREAD('classpath:/csv/facility.csv')");
//        jdbcTemplate.execute("Insert into patient select * from CSVREAD('classpath:/csv/patients.csv')");
//        jdbcTemplate.execute("Insert into encounter select * from CSVREAD('classpath:/csv/encounters.csv')");
//
        String sql = "select count(distinct e.patient_hid) from encounter e, patient p where facility_id=:FACILITY: and e.patient_hid=p.patient_hid and e.patient_age_years >= :MIN_YEAR: and e.patient_age_years < :MAX_YEAR: and p.gender=':GENDER:' and e.visit_type=':VISIT_TYPE:' and encounter_datetime=':ENC_DATE:';";
        Map<String, String> map = new HashMap<>();
        map.put("FACILITY", "1000");
        map.put("MIN_YEAR", "4");
        map.put("MAX_YEAR", "15");
        map.put("GENDER", "M");
        map.put("VISIT_TYPE", "outpatient");
        map.put("ENC_DATE", "2014-10-10");
        for (String s : map.keySet()) {
            sql = sql.replace(s, map.get(s));
        }
        System.out.println(sql);
    }

    @Test
    public void shouldPrepareDatabase() {
        jdbcTemplate.execute("Insert into facility select * from CSVREAD('classpath:/csv/facility.csv')");
        jdbcTemplate.execute("Insert into patient select * from CSVREAD('classpath:/csv/patients.csv')");
        jdbcTemplate.execute("Insert into encounter select * from CSVREAD('classpath:/csv/encounters.csv')");

        String sql_for_M_10 = "select count(distinct e.patient_hid) from encounter e, patient p where facility_id=1000 and e.patient_hid=p.patient_hid and e.patient_age_years >= 4 and e.patient_age_years < 15 and p.gender='M' and e.visit_type='outpatient' and encounter_datetime='2014-10-10';";
        String sql_for_M_11 = "select count(distinct e.patient_hid) from encounter e, patient p where facility_id=1000 and e.patient_hid=p.patient_hid and e.patient_age_years >= 4 and e.patient_age_years < 15 and p.gender='M' and e.visit_type='outpatient' and encounter_datetime='2014-10-11';";
        String sql_for_F_11 = "select count(distinct e.patient_hid) from encounter e, patient p where facility_id=1000 and e.patient_hid=p.patient_hid and e.patient_age_years >= 15 and e.patient_age_years < 50 and p.gender='F' and e.visit_type='outpatient' and encounter_datetime='2014-10-11';";
        Integer dataValue_M_10 = executeQuery(sql_for_M_10);
        Integer dataValue_M_11 = executeQuery(sql_for_M_11);
        Integer dataValue_F_11 = executeQuery(sql_for_F_11);
        System.out.println("******************************");
        System.out.println(dataValue_M_10);
        System.out.println(dataValue_M_11);
        System.out.println(dataValue_F_11);
        System.out.println("******************************");
//        assertEquals();
    }

    private Integer executeQuery(String sql) {
        return jdbcTemplate.query(sql, new RowMapper<Integer>() {
            @Override
            public Integer mapRow(ResultSet rs, int rowNum) throws SQLException {
                return rs.getInt(1);
            }
        }).get(0);
    }

    @After
    public void tearDown() {
        DatabaseHelper.clearDatasenseTables(jdbcTemplate);
    }

}

